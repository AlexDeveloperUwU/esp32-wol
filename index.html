<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>WOL Controller</title>
    <script>
      if (
        localStorage.theme === "dark" ||
        (!("theme" in localStorage) &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        document.documentElement.classList.add("dark");
      } else {
        document.documentElement.classList.remove("dark");
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: ["Inter", "system-ui", "sans-serif"],
              mono: ["JetBrains Mono", "monospace"],
            },
            animation: {
              "in-down": "inDown 0.3s ease-out forwards",
              "in-up": "inUp 0.3s ease-out forwards",
              "fade-in": "fadeIn 0.2s ease-out forwards",
              "fade-out": "fadeOut 0.2s ease-out forwards",
            },
            keyframes: {
              inDown: {
                "0%": { transform: "translateY(-20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              inUp: {
                "0%": { transform: "translateY(20px)", opacity: "0" },
                "100%": { transform: "translateY(0)", opacity: "1" },
              },
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
              fadeOut: {
                "0%": { opacity: "1" },
                "100%": { opacity: "0" },
              },
            },
          },
        },
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap");
      body {
        -webkit-tap-highlight-color: transparent;
      }
      .terminal-scroll::-webkit-scrollbar {
        width: 4px;
      }
      .terminal-scroll::-webkit-scrollbar-thumb {
        background: rgba(100, 116, 139, 0.2);
        border-radius: 10px;
      }
    </style>
    <script>
      const APP_VERSION = "1.2.0";
      const CONFIG = {
        broker: "broker.hivemq.com",
        port: 8884,
        baseTopic: "remotewol/",
      };

      let client;
      let currentTopicString = "";
      let pollInterval;
      let heartbeatInterval;
      let pongTimeout;
      let pollAttempts = 0;
      let isConnecting = false;
      const MAX_RETRIES = 12;

      let DEVICE_SERIAL = "";
      let SECRET_KEY = "";

      function loadCredentials() {
        DEVICE_SERIAL = localStorage.getItem("wol_serial") || "";
        SECRET_KEY = localStorage.getItem("wol_secret") || "";

        if (!DEVICE_SERIAL || !SECRET_KEY) {
          showScreen("settings");
        } else {
          document.getElementById("input-serial").value = DEVICE_SERIAL;
          document.getElementById("input-secret").value = SECRET_KEY;
          showScreen("app");
          connect();
        }
      }

      function saveCredentials() {
        const s = document.getElementById("input-serial").value.trim();
        const k = document.getElementById("input-secret").value.trim();

        if (!s || !k) {
          showToast("Please fill in both fields", true);
          return;
        }

        localStorage.setItem("wol_serial", s);
        localStorage.setItem("wol_secret", k);
        location.reload();
      }

      function showToast(msg, isError = false) {
        const toast = document.getElementById("toast");
        const toastMsg = document.getElementById("toast-msg");
        const toastIcon = document.getElementById("toast-icon");

        toastMsg.innerText = msg;

        if (isError) {
          toast.className =
            "fixed top-6 left-1/2 -translate-x-1/2 z-50 bg-red-500 text-white px-6 py-3 rounded-2xl shadow-xl flex items-center gap-3 animate-in-down";
          toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>`;
        } else {
          toast.className =
            "fixed top-6 left-1/2 -translate-x-1/2 z-50 bg-slate-800 text-white px-6 py-3 rounded-2xl shadow-xl flex items-center gap-3 animate-in-down";
          toastIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
        }

        toast.classList.remove("hidden");
        setTimeout(() => {
          toast.classList.add("hidden");
        }, 3000);
      }

      function openModal() {
        const overlay = document.getElementById("modal-overlay");
        overlay.classList.remove("hidden");
        overlay.classList.remove("animate-fade-out");
        overlay.classList.add("animate-fade-in");
      }

      function closeModal() {
        const overlay = document.getElementById("modal-overlay");
        overlay.classList.remove("animate-fade-in");
        overlay.classList.add("animate-fade-out");
        setTimeout(() => {
          overlay.classList.add("hidden");
        }, 200);
      }

      function confirmReset() {
        localStorage.removeItem("wol_serial");
        localStorage.removeItem("wol_secret");
        location.reload();
      }

      function showScreen(name) {
        document.getElementById("screen-app").classList.add("hidden");
        document.getElementById("screen-settings").classList.add("hidden");
        document.getElementById(`screen-${name}`).classList.remove("hidden");
      }

      function log(msg, type = "info") {
        const consoleDiv = document.getElementById("logs");
        const time = new Date().toLocaleTimeString([], {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        let color = "text-slate-500 dark:text-slate-400";
        if (type === "error") color = "text-red-500";
        if (type === "success") color = "text-emerald-500";
        if (type === "stats") color = "text-blue-500 dark:text-blue-400";

        const div = document.createElement("div");
        div.className = "mb-1 leading-tight";
        div.innerHTML = `<span class="opacity-30 mr-2 tabular-nums">${time}</span><span class="${color}">${msg}</span>`;
        consoleDiv.appendChild(div);
        consoleDiv.scrollTop = consoleDiv.scrollHeight;
      }

      function getUtcTopic() {
        const now = new Date();
        const y = now.getUTCFullYear();
        const m = String(now.getUTCMonth() + 1).padStart(2, "0");
        const d = String(now.getUTCDate()).padStart(2, "0");
        const h = String(now.getUTCHours()).padStart(2, "0");
        return `${CONFIG.baseTopic}${DEVICE_SERIAL}/${y}${m}${d}${h}`;
      }

      function getCipherKey() {
        return CryptoJS.SHA256(SECRET_KEY);
      }

      function encryptPayload(plaintext) {
        const key = getCipherKey();
        const iv = CryptoJS.lib.WordArray.random(16);
        const encrypted = CryptoJS.AES.encrypt(plaintext, key, {
          iv: iv,
          padding: CryptoJS.pad.Pkcs7,
          mode: CryptoJS.mode.CBC,
        });
        return iv.toString() + ":" + encrypted.ciphertext.toString();
      }

      function decryptPayload(encryptedStr) {
        try {
          const parts = encryptedStr.split(":");
          if (parts.length !== 2) return null;

          const iv = CryptoJS.enc.Hex.parse(parts[0]);
          const ciphertext = CryptoJS.enc.Hex.parse(parts[1]);
          const key = getCipherKey();

          const cipherParams = CryptoJS.lib.CipherParams.create({
            ciphertext: ciphertext,
          });

          const decrypted = CryptoJS.AES.decrypt(cipherParams, key, {
            iv: iv,
            padding: CryptoJS.pad.Pkcs7,
            mode: CryptoJS.mode.CBC,
          });

          return decrypted.toString(CryptoJS.enc.Utf8);
        } catch (e) {
          console.error("Decrypt error", e);
          return null;
        }
      }

      function generateSignedCommand(cmd) {
        const ts = Math.floor(Date.now() / 1000).toString();
        const raw = cmd + ts;
        const sig = CryptoJS.HmacSHA256(raw, SECRET_KEY).toString(
          CryptoJS.enc.Hex,
        );
        return `${cmd}|${ts}|${sig}`;
      }

      function connect() {
        if (isConnecting) return;
        isConnecting = true;

        updateBrokerStatus("connecting");
        client = new Paho.MQTT.Client(
          CONFIG.broker,
          CONFIG.port,
          "web-" + Date.now(),
        );

        client.onConnectionLost = (res) => {
          isConnecting = false;
          updateBrokerStatus("offline");
          updateEspStatus(false);
          if (res.errorCode !== 0)
            log("Connection lost: " + res.errorMessage, "error");
        };

        client.onMessageArrived = (msg) => {
          const encryptedPayload = msg.payloadString;
          const payload = decryptPayload(encryptedPayload);

          if (!payload) {
            log("Received undecryptable message", "error");
            return;
          }

          if (msg.destinationName.includes("/response")) {
            if (payload === "PONG") {
              clearTimeout(pongTimeout);
              updateEspStatus(true);
            } else if (payload.startsWith("{")) {
              const s = JSON.parse(payload);
              const ram = Math.round(s.mem_free / 1024);
              const disk = Math.round(s.disk_free / 1024);
              log(
                `Stats: RSSI ${s.rssi}dBm | Uptime ${Math.round(s.uptime / 3600)}h | CPU ${s.cpu_freq}MHz (${s.cores} Cores) | RAM ${ram}KB | Disk ${disk}KB`,
                "stats",
              );
            } else {
              updatePCStatus(payload);
              log(
                "PC Status: " + payload,
                payload === "ONLINE" ? "success" : "info",
              );
              clearInterval(pollInterval);
              pollInterval = null;
            }
          }
        };

        client.connect({
          onSuccess: () => {
            isConnecting = false;
            updateBrokerStatus("online");
            currentTopicString = getUtcTopic();
            client.subscribe(currentTopicString + "/response");
            log("Secure Link Active", "success");

            if (heartbeatInterval) clearInterval(heartbeatInterval);
            if (pollInterval) clearInterval(pollInterval);

            startHeartbeat();
            setTimeout(checkStatus, 500);
          },
          onFailure: (res) => {
            isConnecting = false;
            updateBrokerStatus("offline");
            log("Link Failed: " + res.errorMessage, "error");
          },
          useSSL: true,
        });
      }

      function startHeartbeat() {
        const ping = () => {
          if (!client || !client.isConnected()) return;
          const plain = generateSignedCommand("PING");
          const msg = new Paho.MQTT.Message(encryptPayload(plain));
          msg.destinationName = currentTopicString;
          client.send(msg);
          pongTimeout = setTimeout(() => updateEspStatus(false), 5000);
        };
        ping();
        heartbeatInterval = setInterval(ping, 30000);
      }

      function checkStatus() {
        if (!client || !client.isConnected()) return;
        pollAttempts = 0;
        if (pollInterval) clearInterval(pollInterval);
        const poll = () => {
          if (pollAttempts >= MAX_RETRIES) {
            updatePCStatus("TIMEOUT");
            clearInterval(pollInterval);
            pollInterval = null;
            return;
          }
          pollAttempts++;
          const plain = generateSignedCommand("STATUS");
          const msg = new Paho.MQTT.Message(encryptPayload(plain));
          msg.destinationName = currentTopicString;
          client.send(msg);
        };
        poll();
        pollInterval = setInterval(poll, 10000);
      }

      function wake() {
        log("Sending WAKE signal...", "success");
        const plain = generateSignedCommand("WAKE");
        const msg = new Paho.MQTT.Message(encryptPayload(plain));
        msg.destinationName = currentTopicString;
        client.send(msg);
        setTimeout(checkStatus, 1000);
      }

      function getMetrics() {
        const plain = generateSignedCommand("USAGE");
        const msg = new Paho.MQTT.Message(encryptPayload(plain));
        msg.destinationName = currentTopicString;
        client.send(msg);
      }

      function updateBrokerStatus(s) {
        const el = document.getElementById("ind-broker");
        if (el)
          el.className = `w-2 h-2 rounded-full ${s === "online" ? "bg-emerald-500" : s === "connecting" ? "bg-amber-500 animate-pulse" : "bg-red-500"}`;
      }

      function updateEspStatus(alive) {
        const el = document.getElementById("ind-esp");
        if (el)
          el.className = `w-2 h-2 rounded-full ${alive ? "bg-emerald-500" : "bg-red-500"}`;
      }

      function updatePCStatus(s) {
        const text = document.getElementById("pc-status");
        const btn = document.getElementById("btn-wake");
        if (text) text.innerText = s;

        if (!btn) return;

        if (s === "ONLINE") {
          text.className =
            "text-7xl font-black text-emerald-500 dark:text-emerald-400 tracking-tighter transition-colors duration-500";
          btn.disabled = true;
          btn.className =
            "w-full py-5 rounded-2xl bg-slate-200 dark:bg-slate-800 text-slate-400 dark:text-slate-600 font-bold cursor-not-allowed";
        } else if (s === "TIMEOUT") {
          text.className =
            "text-7xl font-black text-red-500 tracking-tighter transition-colors duration-500";
          btn.disabled = false;
          btn.className =
            "w-full py-5 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-black shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all";
        } else {
          text.className =
            "text-7xl font-black text-slate-300 dark:text-slate-800 tracking-tighter transition-colors duration-500";
          btn.disabled = false;
          btn.className =
            "w-full py-5 rounded-2xl bg-gradient-to-r from-emerald-500 to-teal-500 text-white font-black shadow-lg shadow-emerald-500/20 active:scale-[0.98] transition-all";
        }
      }

      function toggleTheme() {
        if (document.documentElement.classList.contains("dark")) {
          document.documentElement.classList.remove("dark");
          localStorage.theme = "light";
        } else {
          document.documentElement.classList.add("dark");
          localStorage.theme = "dark";
        }
      }

      window.onload = () => {
        document.getElementById("app-ver").innerText = `v${APP_VERSION}`;
        loadCredentials();
      };
    </script>
  </head>
  <body
    class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 transition-colors duration-300"
  >
    <div id="toast" class="hidden">
      <div id="toast-icon"></div>
      <span id="toast-msg" class="font-bold text-sm"></span>
    </div>

    <div
      id="modal-overlay"
      class="fixed inset-0 z-50 bg-slate-900/40 dark:bg-black/60 backdrop-blur-sm hidden flex items-center justify-center p-6 animate-fade-in"
    >
      <div
        class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-3xl p-6 shadow-2xl border border-slate-100 dark:border-slate-800 animate-in-up"
      >
        <h3 class="text-xl font-black tracking-tight mb-2">Reset Settings?</h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mb-6 font-medium">
          This will clear your stored serial number and secret key. You will
          need to enter them again.
        </p>
        <div class="flex gap-3">
          <button
            onclick="closeModal()"
            class="flex-1 py-3 rounded-xl bg-slate-100 dark:bg-slate-800 font-bold text-slate-500 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors"
          >
            Cancel
          </button>
          <button
            onclick="confirmReset()"
            class="flex-1 py-3 rounded-xl bg-red-500 font-bold text-white hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20"
          >
            Confirm
          </button>
        </div>
      </div>
    </div>

    <div
      id="screen-settings"
      class="max-w-md mx-auto h-[100dvh] flex flex-col justify-center p-8 hidden animate-fade-in"
    >
      <div class="flex flex-col items-center mb-10">
        <div
          class="w-16 h-16 bg-white dark:bg-slate-900 rounded-3xl flex items-center justify-center mb-6 shadow-sm border border-slate-200 dark:border-slate-800"
        >
          <div class="w-6 h-6 bg-emerald-500 rounded-full animate-pulse"></div>
        </div>
        <h1 class="text-4xl font-black tracking-tighter">SETUP</h1>
        <p
          class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2"
        >
          Configuration Required
        </p>
      </div>

      <div class="space-y-6 w-full">
        <div class="space-y-2">
          <label
            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1"
            >Device Serial</label
          >
          <input
            type="text"
            id="input-serial"
            placeholder="e.g. ESP32-01"
            class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-5 text-lg font-bold outline-none focus:border-emerald-500 transition-colors placeholder:font-normal placeholder:text-slate-300 dark:placeholder:text-slate-700"
          />
        </div>
        <div class="space-y-2">
          <label
            class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1"
            >Secret Key</label
          >
          <input
            type="password"
            id="input-secret"
            placeholder="••••••••"
            class="w-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl p-5 text-lg font-bold outline-none focus:border-emerald-500 transition-colors placeholder:font-normal placeholder:text-slate-300 dark:placeholder:text-slate-700"
          />
        </div>
      </div>

      <button
        onclick="saveCredentials()"
        class="mt-10 w-full py-6 rounded-2xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-black tracking-wide shadow-xl active:scale-95 transition-all"
      >
        START CONTROLLER
      </button>
    </div>

    <div
      id="screen-app"
      class="max-w-md mx-auto h-[100dvh] flex flex-col p-6 gap-6 hidden animate-fade-in"
    >
      <header class="flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-black tracking-tighter">WOL REMOTE</h1>
          <div class="flex gap-4 mt-1">
            <div class="flex items-center gap-1.5">
              <div
                id="ind-broker"
                class="w-2 h-2 rounded-full bg-slate-300"
              ></div>
              <span
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                >Broker</span
              >
            </div>
            <div class="flex items-center gap-1.5">
              <div id="ind-esp" class="w-2 h-2 rounded-full bg-slate-300"></div>
              <span
                class="text-[10px] font-bold text-slate-400 uppercase tracking-widest"
                >ESP32</span
              >
            </div>
          </div>
        </div>
        <div class="flex flex-col items-end gap-1">
          <div class="flex gap-2">
            <button
              onclick="openModal()"
              class="text-[10px] font-bold text-slate-400 hover:text-red-500 transition-colors"
            >
              RESET
            </button>
            <span id="app-ver" class="text-[10px] font-mono opacity-30"
              >v0.0.0</span
            >
          </div>
          <button
            onclick="toggleTheme()"
            class="w-8 h-4 bg-slate-200 dark:bg-slate-800 rounded-full relative transition-colors"
          >
            <div
              class="absolute left-1 dark:left-auto dark:right-1 top-1 w-2 h-2 bg-slate-500 dark:bg-emerald-500 rounded-full transition-all"
            ></div>
          </button>
        </div>
      </header>

      <section class="flex-1 flex flex-col items-center justify-center">
        <span
          class="text-[11px] font-black text-slate-400 dark:text-slate-600 uppercase tracking-[0.4em] mb-4"
          >System Status</span
        >
        <div
          id="pc-status"
          class="text-7xl font-black text-slate-300 dark:text-slate-800 tracking-tighter transition-all duration-500"
        >
          INIT...
        </div>
      </section>

      <div class="space-y-4">
        <button
          id="btn-wake"
          onclick="wake()"
          class="w-full py-5 rounded-2xl bg-slate-200 dark:bg-slate-800 text-slate-400 dark:text-slate-600 font-bold transition-all"
        >
          SEND MAGIC PACKET
        </button>

        <div class="grid grid-cols-2 gap-4">
          <button
            onclick="checkStatus()"
            class="py-3 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-[11px] font-bold uppercase tracking-widest active:bg-slate-50 dark:active:bg-slate-800 transition-colors"
          >
            Refresh
          </button>
          <button
            onclick="getMetrics()"
            class="py-3 rounded-xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 text-[11px] font-bold uppercase tracking-widest active:bg-slate-50 dark:active:bg-slate-800 transition-colors"
          >
            Metrics
          </button>
        </div>
      </div>

      <div class="flex flex-col min-h-0">
        <div class="flex justify-between items-center mb-2 px-1">
          <span
            class="text-[10px] font-bold text-slate-400 dark:text-slate-500 uppercase tracking-widest"
            >Activity Log</span
          >
          <button
            onclick="document.getElementById('logs').innerHTML = ''"
            class="text-[10px] font-bold text-emerald-500 opacity-60 hover:opacity-100"
          >
            CLEAR
          </button>
        </div>
        <div
          id="logs"
          class="terminal-scroll h-48 bg-slate-100 dark:bg-slate-900/50 rounded-2xl p-4 font-mono text-[11px] overflow-y-auto border border-slate-200 dark:border-slate-800/50"
        ></div>
      </div>
    </div>
  </body>
</html>
